<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Creating a Gitlab Runner on a Virtual Machine in Proxmox.'>
<title>Self-hosting a Github Runner</title>

<link rel='canonical' href='https://trwicks.github.io/p/homelab-project-1/'>

<link rel="stylesheet" href="/scss/style.min.f2f21d9d961219a01621263328d8997e1ae3b4f0371d455628df1fdc27d57bd6.css"><meta property='og:title' content='Self-hosting a Github Runner'>
<meta property='og:description' content='Creating a Gitlab Runner on a Virtual Machine in Proxmox.'>
<meta property='og:url' content='https://trwicks.github.io/p/homelab-project-1/'>
<meta property='og:site_name' content='Tim Wicks'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Tech' /><meta property='article:published_time' content='2023-09-11T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2023-09-11T00:00:00&#43;00:00'/><meta property='og:image' content='https://trwicks.github.io/p/homelab-project-1/images/server.png' />
<meta name="twitter:title" content="Self-hosting a Github Runner">
<meta name="twitter:description" content="Creating a Gitlab Runner on a Virtual Machine in Proxmox."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://trwicks.github.io/p/homelab-project-1/images/server.png' />
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/m2_hudc4f6cdcab73f00ec49fe52dd6d696b8_1176096_300x0_resize_box_3.png" width="300"
                            height="279" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">&lt;..&gt;</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Tim Wicks</a></h1>
            <h2 class="site-description">This is my website.</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/trwicks'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/trwicks'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/bio/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Bio</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#dependencies">Dependencies</a></li>
    <li><a href="#proxmox---preliminary-configuration">Proxmox - Preliminary Configuration</a></li>
    <li><a href="#proxmox---vm-template-creation">Proxmox - VM Template Creation</a></li>
    <li><a href="#proxmox---virtual-machine-creation">Proxmox - Virtual Machine Creation</a></li>
    <li><a href="#runner-virtual-machine---self-hosted-runner-configuration">Runner Virtual Machine - Self-hosted Runner Configuration</a></li>
    <li><a href="#github---create-a-workflow">Github - Create a Workflow</a></li>
    <li><a href="#proxmox---remove-resources">Proxmox - Remove Resources</a></li>
    <li><a href="#references">References</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/homelab-project-1/">
                <img src="/p/homelab-project-1/images/server_hufbd4a20af7865966429aac76acda88ee_2900776_800x0_resize_box_3.png"
                        srcset="/p/homelab-project-1/images/server_hufbd4a20af7865966429aac76acda88ee_2900776_800x0_resize_box_3.png 800w, /p/homelab-project-1/images/server_hufbd4a20af7865966429aac76acda88ee_2900776_1600x0_resize_box_3.png 1600w"
                        width="800" 
                        height="483" 
                        loading="lazy"
                        alt="Featured image of post Self-hosting a Github Runner" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/homelab/" style="background-color: #F47174; color: #fff;">
                Homelab
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/homelab-project-1/">Self-hosting a Github Runner</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Creating a Gitlab Runner on a Virtual Machine in Proxmox.
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 11, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    9 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="introduction">Introduction</h2>
<p>This is a guide to document the creation of a Self-hosted Github runner in a homelab environment. The reason to set up a runner in your homelab is that the runner will enable Github workflows to run scripts and other automation software from the runner. This method demonstrates how to use Proxmox to create a VM and install and configure a Gitlab runner and is for testing purposes only. It is a basic project but I believe it makes you more familiar with Proxmox, setting up VMs and installing and configuring software using the command line.</p>
<p>Being comfortable with the command line using either a Linux shell and powershell is a great skill for performing a variety of tasks in different computing environments. A command line is also great as commands can be easily recorded to show how you achieved a task, and these commands can be thrown into a wiki for quick reference material in similar scenarios. Often I fondly remember well explained commands left by admins and developers in a wiki that have worked perfectly a few years after they were initially written.</p>
<p>The rough steps for this demonstration is as follows:</p>
<ul>
<li>Describe dependencies</li>
<li>Create VM template and VM to use on Proxmox
<ul>
<li>Setup new user in Proxmox</li>
<li>Generate and save SSH key for that user to use</li>
<li>Create the runner VM</li>
</ul>
</li>
<li>Install and configure a Github Runner</li>
<li>Run a test workflow</li>
</ul>
<h2 id="dependencies">Dependencies</h2>
<p>What components do we need to complete this project?</p>
<p><strong>Proxmox</strong> -
For starters, I am assuming that you have Proxmox installed (version 8) on a machine somewhere in your homelab. If you don&rsquo;t and would like to set Proxmox up there are a lot of good guides on this subject that will do a better job at running through the initial setup of the Proxmox[1]. I would like to start from a point where Proxmox is alive and kicking, available on a local area network at <code>https://&lt;your proxmox IP&gt;:8006</code>. I am using an old computer to run Proxmox, which has a CPU with 4 cores and 32 GB of RAM and a 1 TB SSD.</p>
<p><strong>Github</strong> -
Having a Github account and test repository is also required for running the Github Workflow and setting up the Github Runner. Github&rsquo;s documentation is a great starting point for understanding Github Workflows and self-hosted runners[3].</p>
<p><strong>Unix Shell</strong> - The only software I need on my local machine to complete this task is an SSH client to access Proxmox. I am going to use the SSH client that comes with Ubuntu on Windows Subsystem for Linux, for this task. Git, or a Git client, is also required for pushing code changes to your Github repository.</p>
<h2 id="proxmox---preliminary-configuration">Proxmox - Preliminary Configuration</h2>
<p>For this part I will SSH into the Proxmox host in order to create a VM template that can be used to create Virtual Machines on the Proxmox hypervisor. I find creating the template using the command line is quicker and repeatable than trying to use the Proxmox web interface.</p>
<p>First, I will need a non-root user for creating templates and virtual machines on Proxmox. You can use the root user but I think it is good to have some basic familiarity with how to create Linux users that integrate with the Proxmox service. This knowledge is also useful if you need to create a separate user account for running other automation using Terraform or Ansible. For this project I will create a Linux group called &ldquo;homelabbers&rdquo; and a Linux user called &ldquo;homelab&rdquo;. The Linux group will have Admin privileges on Proxmox and the Linux user will belong to this group, inheriting those permissions.</p>
<p>The commands to perform this are given below. To perform these commands you will need to SSH onto the Proxmox server using the root user&rsquo;s credentials.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Set the names of the user and group variables.</span>
</span></span><span class="line"><span class="cl"><span class="nv">GROUP</span><span class="o">=</span>homelabbers
</span></span><span class="line"><span class="cl"><span class="nv">USER</span><span class="o">=</span>homelab
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create and configure the Linux/PVE group.</span>
</span></span><span class="line"><span class="cl">groupadd <span class="nv">$GROUP</span>
</span></span><span class="line"><span class="cl">pveum groupadd <span class="nv">$GROUP</span> -comment <span class="s2">&#34;Homelab Admins&#34;</span>
</span></span><span class="line"><span class="cl">pveum acl modify / --roles Administrator --group <span class="nv">$GROUP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create and configure the homelab user, create a password, and associate the user with the homelabbers, sudo and kvm group.</span>
</span></span><span class="line"><span class="cl">useradd -g <span class="nv">$GROUP</span> -m <span class="nv">$USER</span>
</span></span><span class="line"><span class="cl">usermod -a -G sudo homelab
</span></span><span class="line"><span class="cl">usermod -a -G kvm homelab
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">passwd <span class="nv">$USER</span> <span class="c1"># prompts for a password.</span>
</span></span><span class="line"><span class="cl">pveum user add <span class="nv">$USER</span>@pam
</span></span><span class="line"><span class="cl">pveum user list
</span></span><span class="line"><span class="cl">pveum usermod <span class="nv">$USER</span>@pam -group <span class="nv">$GROUP</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As an optional quality of life improvement, modify the sudoers file to grant passwordless access to superuser commands.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">visudo
</span></span><span class="line"><span class="cl"><span class="c1"># change line %sudo ALL=(ALL:ALL) ALL to %sudo ALL=(ALL:ALL) NOPASSWD: ALL</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The next command creates an SSH key pair and copies the public SSH key to the Proxmox host so you can connect to the machine using the homelab user. The public key is copied to the homelab&rsquo;s home directory using <code>scp</code>. For test environments I like to use separate key pairs so my important SSH keys are not mixed up in test environments.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">PROXMOX_HOST</span><span class="o">=</span>192.168.1.10
</span></span><span class="line"><span class="cl"><span class="nv">KEY_NAME</span><span class="o">=</span>homelab
</span></span><span class="line"><span class="cl">ssh-keygen -t ecdsa -f <span class="nv">$KEY_NAME</span>
</span></span><span class="line"><span class="cl">ssh-copy-id -i <span class="nv">$KEY_NAME</span> homelab@<span class="nv">$PROXMOX_HOST</span>
</span></span><span class="line"><span class="cl">scp -i <span class="nv">$KEY_NAME</span> <span class="nv">$KEY_NAME</span>.pub homelab@<span class="nv">$PROXMOX_HOST</span>:~/
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="proxmox---vm-template-creation">Proxmox - VM Template Creation</h2>
<p>A VM template is required to make VM clones that are used as the foundation for new Virtual Machines that will run in the homelab Proxmox environment. The following script block installs some dependencies on the Proxmox host and then downloads and sets up a VM template.</p>
<p>There is a bit going on in the code block so I have broken it down into two chunks. First, we need to update the package lists on Proxmox to remove the Proxmox enterprise repositories (subscription required) and add debian repositories so we can install some packages.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Note: connect to Proxmox host ssh -i homelab homelab@$PROXMOX_HOST</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo rm /etc/apt/apt.conf.d/10pveapthook
</span></span><span class="line"><span class="cl">sudo rm /etc/apt/sources.list.d/pve-enterprise.list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription&#34;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/proxmox.list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install -y libguestfs-tools
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, I download the Debian Cloud Image to the Proxmox host and use QEMU/KVM  CLI tool (<code>qm</code>) to create a VM using ID of 9000, set up disks used by the VM and finally creating a template from the VM [2]. The <code>virt-customize</code> tool is used to install the guest agent software so Proxmox can receive information from the VM.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">IMG_URL</span><span class="o">=</span>https://cloud.debian.org/images/cloud/bullseye/20230802-1460/debian-11-generic-amd64-20230802-1460.qcow2
</span></span><span class="line"><span class="cl"><span class="c1"># From https://cloud.debian.org/images/cloud/bullseye/20230802-1460/</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Needs to be updated occasionally.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">wget -O /tmp/debian-server.img <span class="nv">$IMG_URL</span>
</span></span><span class="line"><span class="cl">virt-customize -a /tmp/debian-server.img --install qemu-guest-agent
</span></span><span class="line"><span class="cl">sudo qm create <span class="m">9000</span> --memory <span class="m">2048</span> --name debian-cloudimage <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --agent <span class="nv">enabled</span><span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --net0 virtio,bridge<span class="o">=</span>vmbr0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo qm importdisk <span class="m">9000</span> /tmp/debian-server.img local-lvm
</span></span><span class="line"><span class="cl">sudo qm <span class="nb">set</span> <span class="m">9000</span> --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-9000-disk-0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo qm <span class="nb">set</span> <span class="m">9000</span> --ide2 local-lvm:cloudinit
</span></span><span class="line"><span class="cl">sudo qm <span class="nb">set</span> <span class="m">9000</span> --boot c --bootdisk scsi0
</span></span><span class="line"><span class="cl">sudo qm <span class="nb">set</span> <span class="m">9000</span> --serial0 socket --vga serial0
</span></span><span class="line"><span class="cl">sudo qm template <span class="m">9000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The created VM template should be listed on the Proxmox web interface.</p>
<p><img src="/p/homelab-project-1/images/template-proxmox.png"
	width="296"
	height="113"
	srcset="/p/homelab-project-1/images/template-proxmox_hu21bb2b5592b08c387ae386e3fadc7f7e_9740_480x0_resize_box_3.png 480w, /p/homelab-project-1/images/template-proxmox_hu21bb2b5592b08c387ae386e3fadc7f7e_9740_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="Proxmox Template"
	
	
		class="gallery-image" 
		data-flex-grow="261"
		data-flex-basis="628px"
	
></p>
<h2 id="proxmox---virtual-machine-creation">Proxmox - Virtual Machine Creation</h2>
<p>After the VM Template is available on the Proxmox host a single VM is created with a static IP address and the SSH key of the homelab user for accessing the VM once it is created. The <code>qm set</code> commands configure the VM to use a specific IP address (please change this to suit your network requirements), network gateway, CPU and RAM, and public ssh key. Finally the root volume of the VM is resized to 50GB and the VM is started.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">VM_ID</span><span class="o">=</span><span class="m">9100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo qm clone <span class="m">9000</span> <span class="nv">$VM_ID</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --name runner <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --full
</span></span><span class="line"><span class="cl">sudo qm <span class="nb">set</span> <span class="nv">$VM_ID</span> --cores <span class="m">2</span> --memory <span class="m">4096</span>
</span></span><span class="line"><span class="cl">sudo qm <span class="nb">set</span> <span class="nv">$VM_ID</span> --ipconfig0 <span class="nv">ip</span><span class="o">=</span>192.168.1.15/24,gw<span class="o">=</span>192.168.1.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo qm <span class="nb">set</span> <span class="nv">$VM_ID</span> --sshkey ~/homelab.pub
</span></span><span class="line"><span class="cl">sudo qm <span class="nb">set</span> <span class="nv">$VM_ID</span> --nameserver 1.1.1.1
</span></span><span class="line"><span class="cl">sudo qm <span class="nb">set</span> <span class="nv">$VM_ID</span> --ciuser admin
</span></span><span class="line"><span class="cl">sudo qm resize <span class="nv">$VM_ID</span> scsi0 +50G
</span></span><span class="line"><span class="cl">sudo qm start <span class="nv">$VM_ID</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="runner-virtual-machine---self-hosted-runner-configuration">Runner Virtual Machine - Self-hosted Runner Configuration</h2>
<p>For this example I will use the installation instructions provided by Github. These instructions are found by navigating to the Settings &gt; Actions &gt; Runner page in your repository and selecting &ldquo;New self-hosted runner&rdquo;.</p>
<!-- raw HTML omitted -->
<p>On the following page grab the download and configuration commands and run those commands on the Proxmox VM runner.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir actions-runner <span class="o">&amp;&amp;</span> <span class="nb">cd</span> actions-runner
</span></span><span class="line"><span class="cl">curl -o actions-runner-linux-x64-2.308.0.tar.gz -L https://github.com/actions/runner/releases/download/v2.308.0/actions-runner-linux-x64-2.308.0.tar.gz
</span></span><span class="line"><span class="cl">tar xzf ./actions-runner-linux-x64-2.308.0.tar.gz
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Note: I have labelled the runner &#34;homelab&#34; by passing the `--labels homelab` flag during the configuration command.</span>
</span></span><span class="line"><span class="cl">./config.sh --unattended --labels homelab --url https://github.com/trwicks/homelab <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --name homelab-runner --token &lt;token&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo ./svc.sh install
</span></span><span class="line"><span class="cl">sudo ./svc.sh start
</span></span><span class="line"><span class="cl">sudo ./svc.sh status
</span></span></code></pre></td></tr></table>
</div>
</div><p>If this has worked correctly the runner should be in an idle state.</p>
<p><img src="/p/homelab-project-1/images/github-runner-idle.png"
	width="785"
	height="111"
	srcset="/p/homelab-project-1/images/github-runner-idle_huc1a0c651851735ad03fb4734ee62329b_6322_480x0_resize_box_3.png 480w, /p/homelab-project-1/images/github-runner-idle_huc1a0c651851735ad03fb4734ee62329b_6322_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="&ldquo;Runner Idle&rdquo;"
	
	
		class="gallery-image" 
		data-flex-grow="707"
		data-flex-basis="1697px"
	
></p>
<h2 id="github---create-a-workflow">Github - Create a Workflow</h2>
<p>Lastly, I want to create a Github Action to use the runner to run some simple commands.</p>
<p>Create the workflow template in your .github/workflows directory. The workflow template below runs every 5 minutes on the self-hosted runner labelled &ldquo;homelab&rdquo;. Every time the workflow is executed the self-hosted runner will run the commands <code>ip addr; whoami</code> and this will be displayed in the output section of the workflow on Github.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">project-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">schedule</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="nt">cron</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;*/5 * * * *&#39;</span><span class="w"> </span><span class="c"># every 5 mins</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">just-some-commands</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">runs-on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="l">homelab</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">ip addr; whoami</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Commit and push the new workflow file up to your repository.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git add .github/workflows/&lt;workflow filename&gt;
</span></span><span class="line"><span class="cl">git commit -m <span class="s2">&#34;Adding test workflow.&#34;</span>
</span></span><span class="line"><span class="cl">git push origin &lt;your branch&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the Github Action console the Workflow should have been successfully run and outputs from the commands are displayed.</p>
<p><img src="/p/homelab-project-1/images/runner-job.png"
	width="1392"
	height="772"
	srcset="/p/homelab-project-1/images/runner-job_hu51ec231b41b4e7de4a48109aefbab36f_61016_480x0_resize_box_3.png 480w, /p/homelab-project-1/images/runner-job_hu51ec231b41b4e7de4a48109aefbab36f_61016_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="&ldquo;Github Job&rdquo;"
	
	
		class="gallery-image" 
		data-flex-grow="180"
		data-flex-basis="432px"
	
></p>
<h2 id="proxmox---remove-resources">Proxmox - Remove Resources</h2>
<p>To remove the VM and VM template run the following commands from the homelab or root user on Proxmox.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Stop and destroy the Gitlab Runner VM
</span></span><span class="line"><span class="cl">qm stop 9001
</span></span><span class="line"><span class="cl">qm destroy 9001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Remove the created template
</span></span><span class="line"><span class="cl">qm destroy 9000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Remove the homelab user
</span></span><span class="line"><span class="cl">pveum user delete homelab@pam
</span></span><span class="line"><span class="cl">userdel homelab
</span></span><span class="line"><span class="cl">pveum user list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Remove the homelab group
</span></span><span class="line"><span class="cl">pveum group delete homelabbers
</span></span><span class="line"><span class="cl">groupdel homelabbers
</span></span><span class="line"><span class="cl">pveum group list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Remove the workflow
</span></span><span class="line"><span class="cl">rm .github/workflows/&lt;workflow filename&gt;
</span></span><span class="line"><span class="cl">git add .github/workflows/&lt;workflow filename&gt;
</span></span><span class="line"><span class="cl">git commit -m &#34;Removing test workflow.&#34;
</span></span><span class="line"><span class="cl">git push origin &lt;your branch&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Thank you for reading.</p>
<h2 id="references">References</h2>
<ul>
<li>[1] - <a class="link" href="https://www.youtube.com/watch?v=sZcOlW-DwrU"  target="_blank" rel="noopener"
    >Getting Started with Proxmox (Youtube)</a></li>
<li>[2] - <a class="link" href="https://pve.proxmox.com/pve-docs/qm.1.html"  target="_blank" rel="noopener"
    >QEMU/KVM CLI docs</a></li>
<li>[3] - <a class="link" href="https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners/about-self-hosted-runners"  target="_blank" rel="noopener"
    >Github Documentation - Self-hosted Runners</a></li>
<li>[4] - <a class="link" href="https://www.redhat.com/sysadmin/manage-multiple-ssh-key-pairs"  target="_blank" rel="noopener"
    >Managing SSH Keys - Redhat</a></li>
</ul>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/tech/">Tech</a>
        
    </section>


    </footer>


    
</article>

    

    

     
    
        
    <div class="disqus-container">
    
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2023 Tim Wicks
    </section>
    
    <section class="powerby">
        
            Tim Wicks - Learning <br/>
        
    </section>
</footer>

    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
